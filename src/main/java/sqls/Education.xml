<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mul.cam.a.dao.EducationDao">

	<!-- 교육기관등록  -->
	<insert id="eduAdd" parameterType="mul.cam.a.dto.EducationDto">
		INSERT INTO EDUCATION(EDU_CODE, EDU_NAME, EDU_ADDRESS, EDU_PHONE)
		VALUES(#{eduCode}, #{eduName}, #{eduAddress}, #{eduPhone})
	</insert>
	
	<!-- 교육기관등록 시 메인계정 생성  -->
	<insert id="eduAddAdmain" parameterType="mul.cam.a.dto.UserDto">
		INSERT INTO USER(ID, PASSWORD, NAME, ADDRESS, PHONE, AUTH)
		VALUES(#{id}, #{password}, #{name}, #{address}, #{phone}, 'main')
	</insert>
	<!-- 교육기관 등록 시 useredu에도 추가 -->
	<insert id="userEduAdd" parameterType="mul.cam.a.dto.EducationDto">
		INSERT INTO USEREDU(USER_ID, EDU_CODE)
		VALUES(#{id}, #{eduCode})
	</insert>
	
	<!-- 교육기관코드 중복체크 -->
	<select id="eduCodeCheck" parameterType="String" resultType="Integer">
		SELECT COUNT(*)
		FROM EDUCATION
		WHERE EDU_CODE=#{eduCode}
	</select>
	
	<!-- 이미 등록된 교육기관 중복체크 -->
	<select id="eduDuplicateCheck" parameterType="mul.cam.a.dto.EducationDto" resultType="Integer">
		SELECT COUNT(*)
		FROM EDUCATION
		WHERE EDU_ADDRESS=#{eduAddress} AND EDU_NAME=#{eduName}
	</select>
	
	<!-- 교육기관리스트 가져오기 -->
	<select id="getEduList" parameterType="mul.cam.a.dto.ListParam" resultType="mul.cam.a.dto.EducationDto">
		SELECT E.EDU_CODE, E.EDU_NAME, E.EDU_PHONE,
			   E.EDU_ADDRESS, I.ADDRESS,
			   I.ID
		FROM
		EDUCATION E INNER JOIN USER I
		ON E.EDU_ADDRESS = I.ADDRESS
		WHERE 1=1
		<if test="choice != null and choice != '' and search != null and search != '' ">
			<if test="choice == 'eduCode'">
	 			AND EDU_CODE =#{search}
		 	</if>
		 	<if test="choice == 'eduName'">
		 		AND EDU_NAME LIKE CONCAT("%", #{search}, "%")
		 	</if>
		 	<if test="choice == 'eduAddress'">
		 		AND EDU_ADDRESS LIKE CONCAT("%", #{search}, "%")
		 	</if>
		</if>
		LIMIT #{start}, #{end}
	</select>
	
	<!-- 교육기관 총 수 가져오기 -->
	<select id="getAllEdu" parameterType="mul.cam.a.dto.ListParam" resultType="Integer">
		SELECT IFNULL(COUNT(*), 0)
		FROM EDUCATION
		<if test="choice != null and choice != '' and search != null and search != '' ">
		 	<if test="choice == 'eduCode'">
		 		WHERE EDU_CODE =#{search}
		 	</if>
		 	<if test="choice == 'eduName'">
		 		WHERE EDU_NAME LIKE CONCAT('%', #{search}, '%')
		 	</if>
		 	<if test="choice == 'eduAddress'">
		 		WHERE EDU_ADDRESS LIKE CONCAT('%', #{search}, '%')
		 	</if>
		 </if>
	</select>
	
	<!-- 교육기관 데이터 가져오기 -->
	<select id="getEdu" parameterType="String" resultType="mul.cam.a.dto.EducationDto">
		SELECT EDU_NAME, EDU_ADDRESS, EDU_PHONE
		FROM EDUCATION
		WHERE EDU_CODE=#{eduCode}
	</select>
	
	<!-- 교육기관 수정 -->
	<update id="eduUpdate" parameterType="mul.cam.a.dto.EducationDto">
		UPDATE EDUCATION E
		INNER JOIN USER U ON E.EDU_ADDRESS = U.ADDRESS
		SET 
		  E.EDU_NAME=#{eduName}, 
		  E.EDU_ADDRESS=#{eduAddress},
		  E.EDU_PHONE=#{eduPhone},
		  U.NAME=#{eduName},
		  U.ADDRESS=#{eduAddress},
		  U.PHONE=#{eduPhone}
		WHERE E.EDU_CODE=#{eduCode} AND U.ID=#{id}
	</update>
	
	<!-- 교육기관 삭제 -->
	<delete id="eduDelete" parameterType="mul.cam.a.dto.EducationDto">
		DELETE EDUCATION, USER
		FROM EDUCATION INNER JOIN USER ON EDUCATION.EDU_ADDRESS = USER.ADDRESS
		WHERE EDUCATION.EDU_CODE=#{eduCode} AND USER.ID=#{id};
	</delete>
	
	<!-- 메일용 교육기관리스트 가져오기 -->
	<select id="getEduMailList" parameterType="mul.cam.a.dto.ListParam" resultType="mul.cam.a.dto.EducationDto">
		SELECT EDU_CODE, EDU_NAME
		FROM
		EDUCATION
		WHERE 1=1
		<if test="choice != null and choice != '' and search != null and search != '' ">
			<if test="choice == 'eduCode'">
	 			AND EDU_CODE LIKE CONCAT("%", #{search}, "%")
		 	</if>
		 	<if test="choice == 'eduName'">
		 		AND EDU_NAME LIKE CONCAT("%", #{search}, "%")
		 	</if>
		</if>
	</select>
	
	<!-- 메일용 아이디리스트 가져오기 -->
	<select id="getIdMailList" parameterType="String" resultType="mul.cam.a.dto.TeacherUserDto">
		SELECT E.EDU_CODE, E.EDU_NAME, I.ID, I.NAME
		FROM
		EDUCATION E INNER JOIN USEREDU UE
			ON E.EDU_CODE = UE.EDU_CODE
				INNER JOIN USER I
					ON UE.USER_ID = I.ID
		WHERE I.ID LIKE CONCAT("%", #{search}, "%")
	</select>
	<!-- 메일용 교육기관 아이디 가져오기 -->
	<select id="getEduIdMailList" parameterType="String" resultType="mul.cam.a.dto.TeacherUserDto">
		SELECT I.ID
		FROM
		USEREDU UE INNER JOIN USER I
			ON UE.USER_ID = I.ID
		WHERE EDU_CODE=#{eduCode}
	</select>
	<!-- 관리자 보낸 메일 리스트 -->
	<select id="sendMaillist" parameterType="mul.cam.a.dto.MailParam"
		resultType="mul.cam.a.dto.MailDto">
		select sender, GROUP_CONCAT(receiver SEPARATOR ',') AS receiver, title, content, wdate, readcount, filename, newfilename, receivedel, educode, senddel, subcode
		from mail
		where 1=1 
		and sender = #{sender}
		and senddel = 0
		<if test="choice != null and choice != '' and search != null and search != '' ">
		 	<if test="choice == 'title'">
		 		and title like concat('%', #{search}, '%')
		 	</if>
		 	<if test="choice == 'content'">
		 		and content like concat('%', #{search}, '%')
		 	</if>
		 	<if test="choice == 'receiver'">
		 		and receiver=#{search}
		 	</if>
		</if>
		GROUP BY wdate, sender,title, content, wdate, readcount, filename, newfilename, receivedel, educode, senddel, subcode
		order by wdate desc
	<!-- 	where rnum between ${start} and ${end} -->
	</select>
	<!-- 관리자보낸 메일의 총수 -->
	<select id="getsendAllMail" parameterType="mul.cam.a.dto.MailParam" resultType="Integer">
		select ifnull(count(*), 0)
		from mail
		where 1=1
		and sender = #{sender}
		and senddel = 0
		<if test="choice != null and choice != '' and search != null and search != '' ">
		 	<if test="choice == 'title'">
		 		and title like concat('%', #{search}, '%')
		 	</if>
		 	<if test="choice == 'content'">
		 		and content like concat('%', #{search}, '%')
		 	</if>
	 		<if test="choice == 'receiver'">
		 		and receiver=#{search}
		 	</if>
		</if>
	</select>
	<!-- 관리자 보낸 메일 디테일 -->
	<select id="getSendMailDetail" parameterType="String"
		resultType="mul.cam.a.dto.MailDto">
		select sender, GROUP_CONCAT(receiver SEPARATOR ',') AS receiver, title, content, wdate, readcount, filename, newfilename, receivedel, educode, senddel, subcode
		from mail
		where 1=1 
		and wdate = #{wdate}
		and senddel = 0
		GROUP BY wdate, sender,title, content, wdate, readcount, filename, newfilename, receivedel, educode, senddel, subcode
		order by wdate desc
	<!-- 	where rnum between ${start} and ${end} -->
	</select>
</mapper>